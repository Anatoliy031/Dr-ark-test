<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />
  <title>–° –¥–Ω—ë–º —Ä–æ–∂–¥–µ–Ω–∏—è, –°–µ—Ä–≥–µ–π –í–∞–ª–µ–Ω—Ç–∏–Ω–æ–≤–∏—á!</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    :root{--bg1:#667eea;--bg2:#764ba2;--glass:rgba(255,255,255,.95);--accent:#ff6b6b}
    body{min-height:100vh;background:linear-gradient(135deg,var(--bg1),var(--bg2));font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;overflow-x:hidden;position:relative}

    /* Fireworks canvas (front) */
    #fw-canvas{position:fixed;inset:0;width:100%;height:100%;z-index:999;pointer-events:none}

    /* Background particles */
    .particles{position:fixed;inset:0;pointer-events:none;z-index:1}
    .particle{position:absolute;width:4px;height:4px;border-radius:50%;background:rgba(255,255,255,.8);animation:float 15s linear infinite}
    @keyframes float{0%{transform:translateY(100vh) rotate(0);opacity:0}10%,90%{opacity:1}100%{transform:translateY(-100vh) rotate(360deg);opacity:0}}

    .container{position:relative;z-index:10;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:16px}
    .birthday-card{
      width:min(640px,100%);background:var(--glass);backdrop-filter:blur(20px);border-radius:24px;padding:22px;
      box-shadow:0 25px 50px rgba(0,0,0,.15),0 0 0 1px rgba(255,255,255,.08);
      transform:translateY(20px);opacity:0;animation:slideUp .8s ease-out .2s forwards;position:relative;overflow:hidden
    }
    @keyframes slideUp{to{transform:translateY(0);opacity:1}}
    .card-decoration{position:absolute;width:160px;height:160px;border-radius:50%;top:-50px;right:-50px;opacity:.08;background:linear-gradient(45deg,#ff6b6b,#ffd93d);animation:pulse 3s ease-in-out infinite}
    .card-decoration:nth-child(2){top:auto;bottom:-40px;left:-40px;right:auto;background:linear-gradient(45deg,#4ecdc4,#44a08d);animation-delay:1s}
    @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}

    .main-title{
      font-family:'Dancing Script',cursive;font-size:clamp(2.4rem,6vw,3.8rem);font-weight:700;text-align:center;
      background:linear-gradient(135deg,var(--bg1),var(--bg2));-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:6px
    }
    .subtitle{text-align:center;font-size:1.05rem;color:#666;margin-bottom:18px;font-weight:300}

    .avatar-container{display:flex;justify-content:center;margin-bottom:18px}
    .avatar{
      width:160px;height:160px;border-radius:50%;position:relative;overflow:hidden;display:flex;align-items:center;justify-content:center;
      color:#fff;font-size:3rem;font-weight:800;background:linear-gradient(135deg,var(--bg1),var(--bg2));
      border:6px solid #fff;box-shadow:0 12px 28px rgba(0,0,0,.18);animation:bounce 2s ease-in-out infinite
    }
    .avatar::before{content:"";position:absolute;inset:-50%;background:linear-gradient(45deg,transparent,rgba(255,255,255,.32),transparent);transform:rotate(45deg);animation:shine 3s ease-in-out infinite}
    .avatar .initials{position:relative;z-index:1}
    @keyframes bounce{0%,20%,50%,80%,100%{transform:translateY(0)}40%{transform:translateY(-10px)}60%{transform:translateY(-5px)}}
    @keyframes shine{0%{transform:translate(-100%,-100%) rotate(45deg)}50%{transform:translate(100%,100%) rotate(45deg)}100%{transform:translate(-100%,-100%) rotate(45deg)}}

    /* Typewriter */
    .typewriter{font-size:1.1rem;font-weight:800;color:var(--accent);text-align:center;margin:10px 0 14px;min-height:56px;display:flex;align-items:center;justify-content:center;padding:0 8px}
    .cursor{display:inline-block;width:2px;background:var(--accent);margin-left:4px;animation:blink 1s infinite}
    @keyframes blink{0%,50%{opacity:1}51%,100%{opacity:0}}

    .wrong{position:relative;color:#d35c5c;text-decoration:line-through;text-decoration-thickness:2px}
    .message{font-size:1.02rem;line-height:1.65;color:#3a3a3a;text-align:center}
    .message p{margin-bottom:10px}
    .signature{text-align:center;font-size:1.08rem;font-weight:700;color:#5263e9;margin-top:16px}

    .fireworks-btn{
      display:block;margin:18px auto 4px;padding:13px 26px;background:linear-gradient(135deg,#ff6b6b,#ffd93d);color:#fff;border:0;border-radius:999px;
      font-size:1rem;font-weight:700;cursor:pointer;transition:transform .2s,box-shadow .2s;box-shadow:0 10px 22px rgba(255,107,107,.3)
    }
    .fireworks-btn:hover{transform:translateY(-2px);box-shadow:0 14px 28px rgba(255,107,107,.42)}
    .fireworks-btn:active{transform:translateY(0)}

    /* Emoji rain (subtle) */
    .emoji-rain{position:fixed;inset:0;pointer-events:none;z-index:5}
    .falling-emoji{position:absolute;font-size:22px;animation:fall 4.8s linear forwards}
    @keyframes fall{from{transform:translateY(-100vh) rotate(0);opacity:1}to{transform:translateY(100vh) rotate(360deg);opacity:0}}

    /* Sound/Haptics toggle */
    .sound-toggle{
      position:fixed;right:14px;bottom:14px;z-index:1000;
      background:rgba(0,0,0,.5);backdrop-filter:blur(8px);color:#fff;border:0;border-radius:999px;
      padding:10px 14px;font-weight:700;display:flex;align-items:center;gap:8px;cursor:pointer
    }
    .sound-toggle span{font-size:0.92rem;opacity:.9}
    .sound-toggle .dot{width:8px;height:8px;border-radius:50%;background:#f87171}
    .sound-on .dot{background:#34d399}

    @media (max-width:768px){
      .birthday-card{padding:20px}
      .avatar{width:132px;height:132px;font-size:2.5rem}
      .typewriter{font-size:1.02rem;min-height:48px}
      .message{font-size:.98rem}
    }
  </style>
</head>
<body>
  <canvas id="fw-canvas"></canvas>

  <div class="particles" id="particles"></div>
  <div class="emoji-rain" id="emojiRain"></div>

  <div class="container">
    <div class="birthday-card">
      <div class="card-decoration"></div>
      <div class="card-decoration"></div>

      <h1 class="main-title">–° –¥–Ω—ë–º —Ä–æ–∂–¥–µ–Ω–∏—è!</h1>
      <p class="subtitle">–°–µ—Ä–≥–µ–π –í–∞–ª–µ–Ω—Ç–∏–Ω–æ–≤–∏—á</p>

      <div class="avatar-container">
        <div class="avatar" id="avatar"><span class="initials">–°–í</span></div>
      </div>

      <div class="typewriter"><span id="typewriter-text"></span><span class="cursor">&nbsp;</span></div>

      <div class="message">
        <p>–ñ–µ–ª–∞–µ–º –º–æ—â–Ω–æ–≥–æ –∑–¥–æ—Ä–æ–≤—å—è, –ª—ë–≥–∫–∏—Ö –ø–æ–±–µ–¥ –∏ —Ä–æ–≤–Ω–æ–≥–æ –æ–≥–Ω—è –≤ –¥–µ–ª–∞—Ö! üî•</p>
        <p>–ü—É—Å—Ç—å –±–∞–Ω—å–∫–∞ –≤—Å–µ–≥–¥–∞ –≤ —Ç–æ–Ω—É—Å–µ, –º–∞–Ω–≥–∞–ª ‚Äî –±–µ–∑ –¥—ã–º–∞ –≤ –≥–ª–∞–∑–∞, –∞ –≤—ã—Ö–æ–¥–Ω—ã–µ ‚Äî —Å–ø–ª–æ—à–Ω—ã–µ ¬´–≤–∞—É-–º–æ–º–µ–Ω—Ç—ã¬ª. ‚ú®</p>
        <p>–ü—É—Å—Ç—å –Ω–æ–≤—ã–π –≥–æ–¥ –∂–∏–∑–Ω–∏ –∫–∞—á–∞–µ—Ç –∫–∞–∫ –ª—é–±–∏–º—ã–π —Ç—Ä–µ–∫: –≥—Ä–æ–º–∫–æ, —á–∏—Å—Ç–æ –∏ –Ω–∞ –ø–æ–≤—Ç–æ—Ä–µ! –ë–æ–ª—å—à–µ —Å–º–µ—Ö–∞, –≤–∫—É—Å–Ω—ã—Ö –≤—Å—Ç—Ä–µ—á –∏ –ø–æ–≤–æ–¥–æ–≤ –¥–ª—è –≥–æ—Ä–¥–æ—Å—Ç–∏! üéµ</p>
      </div>

      <div class="signature">–° —Ç–µ–ø–ª–æ–º ‚Äî –ê–Ω–∞—Ç–æ–ª–∏–π –∏ –ò—Ä–∏–Ω–∞ ‚ù§Ô∏è</div>

      <button class="fireworks-btn" id="fw-btn">üéÜ –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∞–ª—é—Ç!</button>
    </div>
  </div>

  <!-- –ó–≤—É–∫/–≤–∏–±—Ä–æ -->
  <button id="soundToggle" class="sound-toggle" aria-pressed="false">
    <div class="dot"></div>
    <span>–ó–≤—É–∫: –≤—ã–∫–ª</span>
  </button>

<script>
/* ===== Background particles ===== */
(function(){
  const wrap = document.getElementById('particles');
  const n = 48;
  for(let i=0;i<n;i++){
    const d=document.createElement('div');
    d.className='particle';
    d.style.left = (Math.random()*100)+'%';
    d.style.animationDelay = (Math.random()*15)+'s';
    d.style.animationDuration = (14+Math.random()*10)+'s';
    wrap.appendChild(d);
  }
})();

/* ===== Emoji rain ===== */
(function(){
  const emojis = ['üéâ','üéÇ','üéà','üéÅ','‚ú®','üåü','üí´','üéä'];
  const rain = document.getElementById('emojiRain');
  function drop(){
    const e=document.createElement('div');
    e.className='falling-emoji';
    e.textContent = emojis[Math.floor(Math.random()*emojis.length)];
    e.style.left = (Math.random()*100)+'%';
    e.style.animationDuration = (3.6+Math.random()*2.2)+'s';
    rain.appendChild(e);
    setTimeout(()=>e.remove(), 5200);
  }
  setInterval(drop, 380);
})();

/* ===== Avatar loader ===== */
(function(){
  const avatar = document.getElementById('avatar');
  const initials = avatar.querySelector('.initials');
  const candidates = [
    "./sergey.jpg","./sergey.JPG","./sergey.jpeg","./sergey.JPEG",
    "./sergey.png","./sergey.PNG","./sergey.webp","./sergey.WEBP",
    "sergey.jpg","sergey.JPG","sergey.jpeg","sergey.JPEG",
    "sergey.png","sergey.PNG","sergey.webp","sergey.WEBP",
    "./photo.jpg","./photo.JPG","./photo.jpeg","./photo.JPEG",
    "./photo.png","./photo.PNG","photo.jpg","photo.JPG",
    "./image.jpg","./image.JPG","image.jpg","image.JPG"
  ];
  let i=0;
  function next(){
    if(i>=candidates.length) return;
    const img = new Image();
    img.onload = () =>{
      initials.style.display='none';
      Object.assign(img.style,{position:'absolute',inset:'0',width:'100%',height:'100%',objectFit:'cover',borderRadius:'50%',zIndex:'0',opacity:'0',transition:'opacity .5s'});
      avatar.appendChild(img);
      requestAnimationFrame(()=>img.style.opacity='1');
    };
    img.onerror = ()=>{ i++; setTimeout(next,10); };
    img.src = candidates[i] + "?v=" + Date.now();
  }
  setTimeout(next,120);
})();

/* ===== Typewriter (tactful gag with strikethrough, then erase) ===== */
(function(){
  const el = document.getElementById('typewriter-text');

  // [prefix, wrong, right, postfix]
  const lines = [
    ["–ñ–µ–ª–∞–µ–º ", "–æ–±—ã—á–Ω–æ–≥–æ", "–∫—Ä–µ–ø–∫–æ–≥–æ", " –∑–¥–æ—Ä–æ–≤—å—è –∏ –±–æ–¥—Ä–æ–≥–æ –Ω–∞—Å—Ç—Ä–æ—è! üí™"],
    ["–ü—É—Å—Ç—å –≤—ã—Ö–æ–¥–Ω—ã–µ –±—É–¥—É—Ç ", "–æ–±—ã—á–Ω—ã–º–∏", "—è—Ä–∫–∏–º–∏", " –∏ –∑–∞–ø–æ–º–∏–Ω–∞—é—â–∏–º–∏—Å—è! ‚ú®"],
    ["–ú–∞–Ω–≥–∞–ª ‚Äî ", "–¥—ã–º–Ω—ã–π", "–±–µ–∑–¥—ã–º–Ω—ã–π", ", –∞ –º—è—Å–æ ‚Äî —Å–æ—á–Ω–æ–µ! üçñ"],
    ["–í –¥–µ–ª–∞—Ö ‚Äî ", "–ø–∞—É–∑–∞", "—É—Å–∫–æ—Ä–µ–Ω–∏–µ", " –∏ —É–≤–µ—Ä–µ–Ω–Ω—ã–µ –ø–æ–±–µ–¥—ã! üöÄ"]
  ];

  const typeDelay=70, eraseDelay=45, holdWrong=700, holdLine=1200, gap=260;

  function typeText(text, fromLen){
    return new Promise(res=>{
      let i=fromLen??0;
      function step(){
        el.textContent = text.slice(0,i+1);
        i++;
        if(i<text.length) setTimeout(step,typeDelay); else res();
      }
      if((text||"").length===0) res(); else setTimeout(step,typeDelay);
    });
  }

  function typePlain(str){ return typeText(str,0); }

  function wrapWrong(prefix, wrong){
    el.innerHTML = `${prefix}<span class="wrong" id="wrong-span">${wrong}</span>`;
  }

  function eraseWrongLetters(){
    return new Promise(res=>{
      const span = document.getElementById('wrong-span');
      if(!span) return res();
      function step(){
        const t = span.textContent;
        if(t.length>0){
          span.textContent = t.slice(0,-1);
          setTimeout(step, eraseDelay);
        }else{
          span.remove(); res();
        }
      }
      setTimeout(step, eraseDelay);
    });
  }

  async function playLine([pre, wrong, right, post]){
    el.textContent=""; await new Promise(r=>setTimeout(r,gap));
    // –ü–µ—á–∞—Ç–∞–µ–º –ø—Ä–µ—Ñ–∏–∫—Å –∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Å–ª–æ–≤–æ ¬´–∫–∞–∫ –±—É–¥—Ç–æ –æ—à–∏–±—Å—è¬ª
    await typePlain(pre+wrong);
    // –ó–∞—á–µ—Ä–∫–∏–≤–∞–µ–º –Ω–µ–≤–µ—Ä–Ω–æ–µ —Å–ª–æ–≤–æ, –Ω–µ —Ç—Ä–æ–≥–∞—è –Ω–∞–±—Ä–∞–Ω–Ω—ã–µ –±—É–∫–≤—ã
    wrapWrong(pre, wrong);
    await new Promise(r=>setTimeout(r, holdWrong));
    // –°—Ç–∏—Ä–∞–µ–º –Ω–µ–≤–µ—Ä–Ω–æ–µ —Å–ª–æ–≤–æ –ø–æ –±—É–∫–≤–∞–º
    await eraseWrongLetters();
    // –ü–µ—á–∞—Ç–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Å–ª–æ–≤–æ –∏ –ø–æ—Å—Ç—Ñ–∏–∫—Å
    await typePlain(pre+right);
    await typeText(pre+right+post, (pre+right).length);
    await new Promise(r=>setTimeout(r, holdLine));
  }

  (async function loop(){
    let i=0; while(true){ await playLine(lines[i%lines.length]); i++; }
  })();
})();

/* ===== WebAudio + Haptics ===== */
const Sound = (function(){
  let ctx = null;
  let enabled = false;

  function ensureCtx(){
    if(!ctx){
      const AC = window.AudioContext || window.webkitAudioContext;
      if(AC) ctx = new AC();
    }
    return ctx;
  }

  function setEnabled(v){
    enabled = !!v;
    if(enabled && ctx?.state === 'suspended') ctx.resume();
  }

  function now(){ return (ctx?ctx.currentTime:0); }

  function playLaunch(){
    if(!enabled || !ensureCtx()) return;
    const t = now();
    // whoosh: noise bandpass
    const noise = ctx.createBufferSource();
    const buffer = ctx.createBuffer(1, ctx.sampleRate*0.2, ctx.sampleRate);
    const data = buffer.getChannelData(0);
    for(let i=0;i<data.length;i++) data[i] = (Math.random()*2-1)*0.6;
    noise.buffer = buffer;

    const bp = ctx.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value=800; bp.Q.value=0.6;
    const gain = ctx.createGain(); gain.gain.setValueAtTime(0.0001,t); gain.gain.exponentialRampToValueAtTime(0.35,t+0.02); gain.gain.exponentialRampToValueAtTime(0.0001,t+0.22);

    noise.connect(bp).connect(gain).connect(ctx.destination);
    noise.start(t); noise.stop(t+0.25);
  }

  function playExplosion(){
    if(!enabled || !ensureCtx()) return;
    const t = now();

    // Body: filtered noise burst
    const noise = ctx.createBufferSource();
    const buffer = ctx.createBuffer(1, ctx.sampleRate*0.6, ctx.sampleRate);
    const data = buffer.getChannelData(0);
    for(let i=0;i<data.length;i++) data[i] = (Math.random()*2-1);
    noise.buffer = buffer;

    const lp = ctx.createBiquadFilter(); lp.type='lowpass'; lp.frequency.setValueAtTime(1800,t); lp.frequency.exponentialRampToValueAtTime(200,t+0.5);
    const gain = ctx.createGain(); gain.gain.setValueAtTime(0.0001,t); gain.gain.exponentialRampToValueAtTime(0.7,t+0.01); gain.gain.exponentialRampToValueAtTime(0.0001,t+0.6);

    noise.connect(lp).connect(gain).connect(ctx.destination);
    noise.start(t); noise.stop(t+0.62);

    // Crackles: several quick pops
    for(let i=0;i<5;i++){
      const delay = 0.08 + Math.random()*0.22;
      const osc = ctx.createOscillator(); osc.type='triangle'; osc.frequency.setValueAtTime(180+Math.random()*220,t+delay);
      const g = ctx.createGain(); g.gain.setValueAtTime(0.0001,t+delay); g.gain.exponentialRampToValueAtTime(0.22,t+delay+0.01); g.gain.exponentialRampToValueAtTime(0.0001,t+delay+0.12);
      osc.connect(g).connect(ctx.destination);
      osc.start(t+delay); osc.stop(t+delay+0.14);
    }
  }

  return { setEnabled, playLaunch, playExplosion, ensureCtx, get enabled(){return enabled} };
})();

/* ===== Sound toggle UI ===== */
(function(){
  const btn = document.getElementById('soundToggle');
  function refresh(){
    btn.classList.toggle('sound-on', Sound.enabled);
    btn.setAttribute('aria-pressed', Sound.enabled ? 'true':'false');
    btn.querySelector('span').textContent = '–ó–≤—É–∫: ' + (Sound.enabled ? '–≤–∫–ª' : '–≤—ã–∫–ª');
  }
  btn.addEventListener('click', ()=>{
    Sound.ensureCtx();
    Sound.setEnabled(!Sound.enabled);
    refresh();
  });
  // –ø–µ—Ä–≤—ã–π —Ç–∞–ø –ø–æ –¥–æ–∫—É–º–µ–Ω—Ç—É ‚Äî —Ä–∞–∑—Ä–µ—à–∞–µ–º –∞—É–¥–∏–æ
  document.addEventListener('pointerdown', ()=>{ if(!Sound.enabled){ Sound.ensureCtx(); } }, {once:true});
  refresh();
})();

/* ===== Realistic Fireworks (Canvas, physics, sound, haptics) ===== */
(function(){
  const canvas = document.getElementById('fw-canvas');
  const ctx = canvas.getContext('2d', { alpha:true });
  let W=0,H=0,DPR=1;
  function resize(){
    DPR = Math.min(window.devicePixelRatio||1, 2);
    W = canvas.width = Math.floor(innerWidth * DPR);
    H = canvas.height = Math.floor(innerHeight * DPR);
    canvas.style.width = innerWidth+'px';
    canvas.style.height = innerHeight+'px';
  }
  resize(); addEventListener('resize', resize);

  const rockets = [], particles = [];
  const MAX_PARTICLES = innerWidth < 480 ? 500 : 900;
  const GRAV = 0.06 * DPR, FRICTION = 0.985, PFR = 0.972, PGR = 0.075 * DPR;

  function rand(a,b){return Math.random()*(b-a)+a}

  function launch(x){
    rockets.push({
      x: (x ?? rand(W*0.2, W*0.8)),
      y: H + 10,
      vx: rand(-0.8,0.8),
      vy: -rand(5.8*DPR, 7.4*DPR),
      hue: rand(0,360),
      life: 0, trail:[]
    });
    Sound.playLaunch();
  }

  function burst(x,y,hue){
    // Haptics
    if(navigator.vibrate){
      try{ navigator.vibrate([20, 30, 20]); }catch(e){}
    }
    // Sound
    Sound.playExplosion();

    const count = Math.round(rand(80,130));
    for(let i=0;i<count;i++){
      const ang = Math.random()*Math.PI*2;
      const spd = rand(1.2*DPR, 4.2*DPR);
      // HSV->RGB lite
      const s = rand(0.55,0.95), v = rand(0.8,1), hh = (hue+rand(-12,12))/60;
      const f = (n,k=(n+hh)%6)=>v-v*s*Math.max(Math.min(k,4-k,1),0);
      const r = Math.floor(f(5)*255), g = Math.floor(f(3)*255), b = Math.floor(f(1)*255);
      particles.push({
        x, y, vx: Math.cos(ang)*spd, vy: Math.sin(ang)*spd,
        a: 1, size: rand(1.2*DPR, 2.6*DPR),
        col:`rgba(${r},${g},${b},`, tw: Math.random()<0.2
      });
    }
  }

  function draw(){
    // trail fade
    ctx.globalCompositeOperation='destination-out';
    ctx.fillStyle = `rgba(0,0,0,${innerWidth<480?0.20:0.16})`;
    ctx.fillRect(0,0,W,H);
    ctx.globalCompositeOperation='lighter';

    // rockets
    for(let i=rockets.length-1;i>=0;i--){
      const r=rockets[i];
      r.vy += GRAV; r.x += r.vx; r.y += r.vy; r.life++;
      r.trail.push([r.x,r.y]); if(r.trail.length>6) r.trail.shift();

      // rocket core
      ctx.beginPath(); ctx.fillStyle='rgba(255,255,255,.9)'; ctx.arc(r.x,r.y,1.8*DPR,0,Math.PI*2); ctx.fill();
      // trail
      for(let t=0;t<r.trail.length-1;t++){
        const p1=r.trail[t], p2=r.trail[t+1];
        ctx.strokeStyle = `rgba(255,255,255,${0.15 + t*0.12})`;
        ctx.lineWidth = (1.2 - t*0.15)*DPR;
        ctx.beginPath(); ctx.moveTo(p1[0],p1[1]); ctx.lineTo(p2[0],p2[1]); ctx.stroke();
      }

      if(r.vy > -0.2 || r.life>140){
        burst(r.x,r.y,r.hue); rockets.splice(i,1);
      }
    }

    // particles
    for(let i=particles.length-1;i>=0;i--){
      const p=particles[i];
      p.vx*=PFR; p.vy=p.vy*PFR + PGR; p.x+=p.vx; p.y+=p.vy;
      p.a -= 0.012 + Math.random()*0.01;
      const a = p.tw ? p.a*(0.5+Math.random()*0.5) : p.a;
      if(a>0){
        ctx.beginPath(); ctx.fillStyle=p.col + a + ')'; ctx.arc(p.x,p.y,p.size,0,Math.PI*2); ctx.fill();
      }else{ particles.splice(i,1); }
    }
    if(particles.length>MAX_PARTICLES){ particles.splice(0, particles.length-MAX_PARTICLES); }

    requestAnimationFrame(draw);
  }

  // Manual and auto
  document.getElementById('fw-btn').addEventListener('click', ()=>{
    for(let i=0;i<12;i++) setTimeout(()=>launch(), i*120);
    setTimeout(()=>{for(let i=0;i<8;i++) setTimeout(()=>launch(), i*90);}, 900);
  });

  function autoWave(dur=8000, interval=850){
    const id = setInterval(()=>{ const n = innerWidth<480?1:(Math.random()<0.5?1:2); for(let i=0;i<n;i++) setTimeout(()=>launch(), i*140); }, interval);
    setTimeout(()=>clearInterval(id), dur);
  }

  draw();
  setTimeout(()=>{ for(let i=0;i<6;i++) setTimeout(()=>launch(), i*120); }, 1400);
  setTimeout(()=>autoWave(), 3200);
  setTimeout(()=>autoWave(), 10500);
})();

/* ===== DOM ready (no-op: IIFEs already started) ===== */
</script>
</body>
</html>
